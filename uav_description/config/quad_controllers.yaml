controller_manager:
  ros__parameters:
    update_rate: 500

    imu_sensor_broadcaster:
      type: imu_sensor_broadcaster/IMUSensorBroadcaster

    magnetometer_broadcaster:
      type: magnetometer_broadcaster/MagnetometerBroadcaster

    rotor_forward:
      type: forward_command_controller/ForwardCommandController

    fusion:
      type: uav/fusion/FusionMadgwick

    fusion_sensor_broadcaster:
      type: imu_sensor_broadcaster/IMUSensorBroadcaster

    joint_state_broadcaster:
      type: joint_state_broadcaster/JointStateBroadcaster

    pose_broadcaster:
      type: pose_broadcaster/PoseBroadcaster

    control_allocation:
      type: uav/control_allocation/ControlAllocationSimple

    angular_velocity:
      type: uav/controllers/AngVelPID

    angular_position:
      type: uav/controllers/AngPosPID

    attitude:
      type: uav/controllers/AttitudePID

    attitude_mode:
      type: uav/mode/AttitudeFlightMode

# Note:
# The raw IMU and magnetometer data is published in the sensor frame
# and intended for calibration. The calibrated and rotated data is
# published in the base frame for use by the controllers.

imu_sensor_broadcaster:
  ros__parameters:
    frame_id: imu
    sensor_name: base_imu

magnetometer_broadcaster:
  ros__parameters:
    frame_id: imu
    sensor_name: base_imu

# The forward controller provides direct access to the rotors via
# topic "/rotor_forward/commands" (std_msgs/msg/Float64MultiArray).
# This is intended for debugging and ESC range calibration.
rotor_forward:
  ros__parameters:
    update_rate: 100
    joints: [
      "rotor/1",
      "rotor/2",
      "rotor/3",
      "rotor/4",
    ]
    interface_name: "velocity"

fusion:
  ros__parameters:
    sensor_name: base_imu
    use_magnetometer: false
    gain: 0.1

fusion_sensor_broadcaster:
  ros__parameters:
    frame_id: base_link
    sensor_name: fusion

pose_broadcaster:
  ros__parameters:
    pose_name: x2
    frame_id: world
    tf:
      child_frame_id: mujoco/x2

angular_velocity:
  ros__parameters:
    mixer: control_allocation
    sensor_name: fusion
    # https://en.wikipedia.org/wiki/Zieglerâ€“Nichols_method
    # Kp = 0.2 * Ku
    # Ki = 0.4 * Ku / Tu
    # Kd = 6/90 * Ku * Tu

    # Ku = 0.8
    # Tu = 0.012 = 1/83.33Hz = 0.012s
    gains:
      roll.p: 0.16
      pitch.p: 0.16
      roll.i: 2.6
      pitch.i: 2.6
      roll.d: 0.00064
      pitch.d: 0.00064
      yaw.p: 3.0

angular_position:
  ros__parameters:
    update_rate: 250
    velocity_controller_name: angular_velocity
    sensor_name: fusion
    gains:
      tau: 0.2
      roll.p: 0.4
      pitch.p: 0.4
      yaw.p: 0.4

attitude:
  ros__parameters:
    velocity_controller_name: angular_velocity
    sensor_name: fusion
    gains:
      roll.p: 2.
      roll.d: 0.01
      pitch.p: 2.
      pitch.d: 0.01
      yaw_rate.p: 0.4

attitude_mode:
  ros__parameters:
    attitude_controller_name: attitude
    mixer: control_allocation
    rpyt_channels: [2, 3, 4, 1]
    max_tilt: 45.
